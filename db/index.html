<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>P3\Db - p3-db</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">p3-db</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="..">p3-db</a>
                    </li>
                    <li class="active">
                        <a href="./">P3\Db</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="..">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li class="disabled">
                        <a rel="prev" >
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/pine3ree/p3-db/edit/master/docs/db.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#p3db">P3\Db</a></li>
            <li><a href="#quick-start">Quick start</a></li>
            <li><a href="#crud-commands">CRUD commands</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="p3db">P3\Db</h1>
<h2 id="quick-start">Quick start</h2>
<pre><code class="php">use P3\Db;
use P3\Db\Factory\DbFactory;
use PDO;

// 1. Create a dbal instance using an existing PDO connection
$pdo = new PDO('my-db-dsn', 'my-db-username', 'my-db-password');
$db = new Db($pdo);

// 2. Create a dbal instance using pdo configuration: the PDO connection is created on demand
$db = new Db('my-db-dsn', 'my-db-username', 'my-db-password');

// 3. Create a dbal instance using a factory: the provided factory fetch a configuration
// array from a psr-container under the `config` id/alias with specific database
// configuration subarray under either a `db` or `pdo` key.
$factory = new DbFactory();
$db = $factory($container);

// fetch all rows from the &quot;product&quot; table
$products = $db-&gt;fetchAll('product');

// fetch the product row with column id = 42
$product = $db-&gt;fetchOneBy('product', 'id', 42);

// same row using `fetchOne()` with condition
$product = $db-&gt;fetchOne('product', ['id' =&gt; 42]);

$fiftyExpensiveProducts = $db-&gt;fetchAll('product', [
    ['price', '&gt;', 1000.00],
], ['price' =&gt; 'ASC'], 50);

$tenMostExpensiveProducts = $db-&gt;fetchAll('product', null, ['price' =&gt; 'DESC'], 10);

$mostExpensiveProduct = $db-&gt;fetchOne('product', null, ['price' =&gt; 'DESC']);

</code></pre>

<h3 id="constructor-arguments">Constructor arguments</h3>
<p><code>P3\Db</code> supports the same constructor arguments as the <code>\PDO</code> class.</p>
<p>It also supports an extra argument, an optional custom PDO subclass to use in
lazy connection instances.</p>
<pre><code class="php">class Db
{
   /**
     * @param string|PDO $dsn_or_pdo A valid pdo dsn string or an existing pdo connection instance
     * @param string|null $username PDO connection username
     * @param string|null $password PDO connection password
     * @param array|null $options PDO connection options
     * @param string|null $pdoClass An optional PDO subclass to use when creating a new connection
     */
    public function __construct(
        $dsn_or_pdo,
        string $username = null,
        string $password = null,
        array $options = null,
        string $pdoClass = null
    ) {
}
//...
</code></pre>

<p>The first argument can also be an existing PDO instance itself, that will be used
as the composed pdo connection.</p>
<h3 id="factory-configuration-parameters">Factory configuration parameters</h3>
<p>Factory configuration retrieved from the container should return an array like the
one below:</p>
<pre><code class="php">// file config.php
return [
    // full dsn specification
    'db' =&gt; [ // alt key: 'pdo' =&gt; [...]
        'dns'      =&gt; 'mysql:dbname=testdb;host=localhost;port=3306;charset=utf8',
        'username' =&gt; 'testuser', // alt key: 'user'
        'password' =&gt; 'secret', // alt key: 'passwd' or 'pass'
    ],
    // ...or single parameters specs
    'db' =&gt; [
        'driver'   =&gt; 'mysql',
        'dbname'   =&gt; 'testdb', // alt key: 'database'
        'host'     =&gt; 'localhost', // alt key: 'hostname'
        'port'     =&gt; 3306,
        'charset'  =&gt; 'utf8',
        'username' =&gt; 'testuser', // alt key: 'user'
        'password' =&gt; 'secret', // alt key: 'passwd' or 'pass'
        'options'  =&gt; [
            // pdo-options array
        ]
    ],
];
</code></pre>

<p>The database configuration subkeys depend on the db driver used and must be all
in snake_case format. Please check the pdo driver page https://www.php.net/manual/en/pdo.drivers.php
for more information.</p>
<p>The factory will attempt to build a valid pdo DSN with the provided configuration parameters.</p>
<p>Supported drivers are <code>mysql</code>, <code>pgsql</code>, <code>sqlite</code>, <code>sqlsrv</code> and <code>oci</code>.</p>
<h2 id="crud-commands">CRUD commands</h2>
<p>To start building a crud databse command you can use the following methods:</p>
<pre><code class="php">$select = $db-&gt;select(); // returns a P3\Db\Command\Select instance
$insert = $db-&gt;insert(); // returns a P3\Db\Command\Insert instance
$update = $db-&gt;update(); // returns a P3\Db\Command\Update instance
$delete = $db-&gt;delete(); // returns a P3\Db\Command\Delete instance
</code></pre>

<p>Database command instances provide a fluent interface for building sql statement.
The sql build is actually perfomed by the composed sql-statement (<code>P3\Db\Sql\Statement</code>)
instance with the help of the sql-driver (<code>P3\Sql\DriverInterface</code>) created for
the current connection.</p>
<p>The corresponding sql-statement objects ca be created with the following <code>P3\Db\Sql</code> helper
class static methods:</p>
<pre><code class="php">$select = Sql::select(); // returns a P3\Db\Sql\Statement\Select instance
$insert = Sql::insert(); // returns a P3\Db\Sql\Statement\Insert instance
$update = Sql::update(); // returns a P3\Db\Sql\Statement\Update instance
$delete = Sql::delete(); // returns a P3\Db\Sql\Statement\Delete instance
</code></pre>

<p>The <code>Sql\Statement</code> classes, as any other <code>Sql\Element</code> class, provide a <code>getSQL()</code>
method which compiles the sql string for the given sql-driver argument or the default
<code>Ansi</code> driver. The sql-drivers provide identifier quoting and other sql transformations
according to the underlying platform. The <code>getSQL()</code> method also collects user-provided
parameter values along with their pdo-param types and sets named markers in their place
into the sql string. The paramater collector can be retrieved by <code>getParams()</code> either from
the sql-statement object or the wrapping command. A internal collector will be created
only if not passed-in as the 2nd argument of the <code>getSQL()</code> call.</p>
<h3 id="dbselect">Db::select()</h3>
<p>Create a select command instance, which is a reader-command, whose method <code>execute()</code>
is forwarded to the reader-command method <code>query()</code>:</p>
<pre><code class="php">$select = $db-&gt;select(); // generic Select command

// SELECT * FROM &quot;product&quot; &quot;p&quot;
$select = $db-&gt;select('*', 'product', 'p');
// equivalent to
$select = $db-&gt;select('*')-&gt;from('product', 'p');
// and to
$select = $db-&gt;select()-&gt;from('product', 'p');

 // SELECT &quot;p&quot;.&quot;price&quot;, &quot;p&quot;.&quot;vat_rate&quot; AS &quot;vatRate&quot; FROM &quot;product&quot; &quot;p&quot;
$select = $db-&gt;select(['price', 'vat_rate' =&gt; 'vatRate'])-&gt;from('product', 'p');

// add where condition and order-by clause
$select-&gt;where-&gt;lte('price', 1000.0); // WHERE &quot;price&quot; &lt;= :lte1 (named parameter marker)
$select-&gt;orderBy('p.price', 'ASC'); // ORDER BY &quot;price&quot; ASC

// SELECT &quot;p&quot;.* FROM &quot;product&quot; &quot;p&quot; ORDER BY &quot;p&quot;.&quot;price&quot; ASC
$select = $db-&gt;select('*')-&gt;from('product', 'p')-&gt;orderBy('p.price');

$stmt = $select-&gt;execute(); // or $select-&gt;query(), returns a PDOStatement or FALSE

// SELECT &quot;category_id&quot; AS &quot;catId&quot;, COUNT(*) AS &quot;numProducts&quot;
// FROM &quot;product&quot; WHERE &quot;price&quot; &gt; :gt1
// GROUP BY &quot;category_id&quot;
// HAVING &quot;numProducts&quot; &gt;= :gte1
$select = $db-&gt;select()
    -&gt;column('category_id', 'catId')
    -&gt;count('*', 'numProducts')
    -&gt;from('product');
    -&gt;where-&gt;gte('price', 10.0);
// using $select-&gt;where or $select-&gt;having changes the scope and the fluent method
// chain is broken
$select-&gt;groupBy('category_id')
    -&gt;having-&gt;gt('numProducts', 5);
// SELECT MIN(&quot;price&quot;) FROM &quot;product&quot; GROUP BY &quot;category_id&quot;
$select = $db-&gt;select()-&gt;min('price')-&gt;from('product')-&gt;groupBy('category_id');
</code></pre>

<h3 id="dbinsert">Db::insert()</h3>
<p>Create and optionally execute an insert command instance, which is a writer-command.</p>
<p>Writer commands (Insert, Update, Delete) method <code>execute()</code> is forwarded to the
writer-command method <code>exec()</code>.</p>
<pre><code class="php">// INSERT INTO &quot;product&quot; (&quot;name&quot;, &quot;price&quot;) VALUES (:val1, :val2)
$insert = $db-&gt;insert()
    -&gt;into('product')
    -&gt;row([
        'name' =&gt; 'product-1',
        'price' =&gt; 100.00,
    ]);

// equivalent to
$insert = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;values(['product-1', 100.00]);

$result = $insert-&gt;execute() // or $insert-&gt;exec(), returns TRUE or FALSE for single row insert
</code></pre>

<p>Insert and execute shortcut call, when both arguments (<code>$table</code> and <code>$row</code>/<code>$rows</code>)
are provided:</p>
<pre><code class="php">$result = $db-&gt;insert('product', [
    'name' =&gt; 'product-111',
    'price' =&gt; 111.11,
]); // returns TRUE or FALSE for single insert

// get the last generated value if the insert is successful
$id = $result ? $db-&gt;lastInsertId() : null;
</code></pre>

<p>Insert many rows:</p>
<pre><code class="php">// INSERT INTO &quot;product&quot; (&quot;name&quot;, &quot;price&quot;) VALUES (:val1, :val2), (:val3, :val4)
$num_inserted = $db-&gt;insert('product', [
    [
        'name' =&gt; 'product-111',
        'price' =&gt; 111.11,
    ],
    [
        'name' =&gt; 'product-222',
        'price' =&gt; 222.22,
    ],
]); // returns integer or FALSE

// equivalent to
$num_inserted = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;values([
        'product-111',
        111.11,
    ])
    -&gt;values([
        'product-222',
        222.22,
    ])-&gt;execute(); // or exec()

// and to
$num_inserted = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;multipleValues([
        [
            'product-111',
            111.11,
        ],
        [
            'product-222',
            222.22,
        ],
    ])-&gt;execute();
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '..';</script>
        <script src="../js/base.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td><kbd>&larr;</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td><kbd>&rarr;</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>


    </body>
</html>
