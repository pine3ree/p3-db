<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Db - p3-db</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Db";
    var mkdocs_page_input_path = "db.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> p3-db</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Db</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#quick-start">Quick start</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#constructor-arguments">Constructor arguments</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#factory-configuration-parameters">Factory configuration parameters</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#crud-commands">CRUD commands</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#dbselect">Db::select()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dbinsert">Db::insert()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dbupdate">Db::update()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#dbdelete">Db::delete()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#sql-driver-proxy-helper-methods">Sql driver proxy helper methods</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">p3-db</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Db</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/pine3ree/p3-db/edit/master/docs/db.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="p3db">P3\Db</h1>
<h2 id="quick-start">Quick start</h2>
<pre><code class="php">use P3\Db;
use P3\Db\Factory\DbFactory;
use PDO;

// 1. Create a dbal instance using an existing PDO connection
$pdo = new PDO('my-db-dsn', 'my-db-username', 'my-db-password');
$db = new Db($pdo);

// 2. Create a dbal instance using pdo configuration: the PDO connection is created on demand
$db = new Db('my-db-dsn', 'my-db-username', 'my-db-password');

// 3. Create a dbal instance using a factory: the provided factory fetch a configuration
// array from a psr-container under the `config` id/alias with specific database
// configuration subarray under either a `db` or `pdo` key.
$factory = new DbFactory();
$db = $factory($container);

// Simple proxy method to \PDO::query() returning a traversable PDOStatement or
// false if query execution fails
$stmt = $db-&gt;query('SELECT * FROM product WHERE price &lt; 100.0 AND id &lt; 100');

// Simple proxy method to \PDO::exec(), returns the number of affected rows, or
// false if execution fails
$affected = $db-&gt;exec('UPDATE product SET published = FALSE WHERE stock &lt;= 0');
</code></pre>

<p>Other examples:</p>
<pre><code class="php">// fetch all rows from the &quot;product&quot; table
// fetchAll(string $table, $where = null, $order = null, int $limit = null, int $offset = null): array
$products = $db-&gt;fetchAll('product');

// fetch the product row with column id = 42
// fetchOneBy(string $table, string $column, $value, $order = null): ?array
$product = $db-&gt;fetchOneBy('product', 'id', 42);

// same row using `fetchOne()` with condition
// fetchOne(string $table, $where = null, $order = null): ?array
$product = $db-&gt;fetchOne('product', ['id' =&gt; 42]);

$fiftyExpensiveProducts = $db-&gt;fetchAll('product', [
    ['price', '&gt;', 1000.00],
], ['price' =&gt; 'ASC'], 50);

$tenMostExpensiveProducts = $db-&gt;fetchAll('product', null, ['price' =&gt; 'DESC'], 10);

$mostExpensiveProduct = $db-&gt;fetchOne('product', null, ['price' =&gt; 'DESC']);
</code></pre>

<h3 id="constructor-arguments">Constructor arguments</h3>
<p><code>P3\Db</code> supports the same constructor arguments as the <code>\PDO</code> class.</p>
<p>It also supports an extra argument, an optional custom PDO subclass to use in
lazy connection instances.</p>
<pre><code class="php">class Db
{
   /**
     * @param string|PDO $dsn_or_pdo A valid pdo dsn string or an existing pdo connection instance
     * @param string|null $username PDO connection username
     * @param string|null $password PDO connection password
     * @param array|null $options PDO connection options
     * @param string|null $pdoClass An optional PDO subclass to use when creating a new connection
     */
    public function __construct(
        $dsn_or_pdo,
        string $username = null,
        string $password = null,
        array $options = null,
        string $pdoClass = null
    ) {
}
//...
</code></pre>

<p>The first argument can also be an existing PDO instance itself, that will be used
as the composed pdo connection.</p>
<h3 id="factory-configuration-parameters">Factory configuration parameters</h3>
<p>Factory configuration retrieved from the container should return an array like the
one below:</p>
<pre><code class="php">// file config.php
return [
    // full dsn specification
    'db' =&gt; [ // alt key: 'pdo' =&gt; [...]
        'dns'      =&gt; 'mysql:dbname=testdb;host=localhost;port=3306;charset=utf8',
        'username' =&gt; 'testuser', // alt key: 'user'
        'password' =&gt; 'secret', // alt key: 'passwd' or 'pass'
    ],
    // ...or single parameters specs
    'db' =&gt; [
        'driver'   =&gt; 'mysql',
        'dbname'   =&gt; 'testdb', // alt key: 'database'
        'host'     =&gt; 'localhost', // alt key: 'hostname'
        'port'     =&gt; 3306,
        'charset'  =&gt; 'utf8',
        'username' =&gt; 'testuser', // alt key: 'user'
        'password' =&gt; 'secret', // alt key: 'passwd' or 'pass'
        'options'  =&gt; [
            // pdo-options array
        ]
    ],
];
</code></pre>

<p>The database configuration subkeys depend on the db driver used and must be all
in snake_case format. Please check the pdo driver page https://www.php.net/manual/en/pdo.drivers.php
for more information.</p>
<p>The factory will attempt to build a valid pdo DSN with the provided configuration parameters.</p>
<p>Supported drivers are <code>mysql</code>, <code>pgsql</code>, <code>sqlite</code>, <code>sqlsrv</code> and <code>oci</code>.</p>
<h2 id="crud-commands">CRUD commands</h2>
<p>To start building a crud databse command you can use the following methods:</p>
<pre><code class="php">$select = $db-&gt;select(); // returns a P3\Db\Command\Select instance
$insert = $db-&gt;insert(); // returns a P3\Db\Command\Insert instance
$update = $db-&gt;update(); // returns a P3\Db\Command\Update instance
$delete = $db-&gt;delete(); // returns a P3\Db\Command\Delete instance
</code></pre>

<p>Database command instances provide a fluent interface for building sql statement.
The sql build is actually perfomed by the composed sql-statement (<code>P3\Db\Sql\Statement</code>)
instance with the help of the sql-driver (<code>P3\Sql\DriverInterface</code>) created for
the current connection.</p>
<p>The corresponding sql-statement objects ca be created with the following <code>P3\Db\Sql</code> helper
class static methods:</p>
<pre><code class="php">$select = Sql::select(); // returns a P3\Db\Sql\Statement\Select instance
$insert = Sql::insert(); // returns a P3\Db\Sql\Statement\Insert instance
$update = Sql::update(); // returns a P3\Db\Sql\Statement\Update instance
$delete = Sql::delete(); // returns a P3\Db\Sql\Statement\Delete instance
</code></pre>

<p>The <code>Sql\Statement</code> classes, as any other <code>Sql\Element</code> class, provide a <code>getSQL()</code>
method which compiles the sql string for the given sql-driver argument or the default
<code>Ansi</code> driver. The sql-drivers provide identifier quoting and other sql transformations
according to the underlying platform. The <code>getSQL()</code> method also collects user-provided
parameter values along with their pdo-param types and sets named markers in their place
into the sql string. The paramater collector can be retrieved by <code>getParams()</code> either from
the sql-statement object or the wrapping command. A internal collector will be created
only if not passed-in as the 2nd argument of the <code>getSQL()</code> call.</p>
<p>All database command classes implement the <code>execute()</code> method.</p>
<ul>
<li>For writer-commands (Insert|Update|Delete) <code>execute()</code> will call the writer
  method <code>Writer::exec()</code> and will return either the number of rows affected or
  <code>false</code> on failure.</li>
<li>For reader-commands (Select) <code>execute()</code> will call the reader method <code>Reader::query()</code>
  and will return either a traversable <code>\PDOStatement</code> result-set object or <code>false</code>
  on failure.</li>
</ul>
<h3 id="dbselect">Db::select()</h3>
<p>Create a <code>P3\Db\Command\Select</code> reader command instance</p>
<pre><code class="php">use P3\Db;
use P3\Db\Sql;

/** @var Db $db */

$select = $db-&gt;select(); // create a generic empty Select command instance

// SELECT * FROM &quot;product&quot;
$select = $db-&gt;select('*', 'product');
$select = $db-&gt;select('*')-&gt;from('product');
$select = $db-&gt;select(null, 'product');
$select = $db-&gt;select()-&gt;from('product');

// use table alias: SELECT * FROM &quot;product&quot; &quot;p&quot;
$select = $db-&gt;select('*', 'product', 'p');
$select = $db-&gt;select('*')-&gt;from('product', 'p');
$select = $db-&gt;select()-&gt;from('product', 'p');

 // SELECT &quot;p&quot;.&quot;price&quot;, &quot;p&quot;.&quot;vat_rate&quot; AS &quot;vatRate&quot; FROM &quot;product&quot; &quot;p&quot;
$select = $db-&gt;select(['price', 'vat_rate' =&gt; 'vatRate'])-&gt;from('product', 'p');

// add where condition LessThanEqual and order-by clause
$select-&gt;where-&gt;lte('price', 1000.0); // WHERE &quot;price&quot; &lt;= :lte1 (named parameter marker)

// ORDER BY &quot;p&quot;.&quot;price&quot; ASC
$select-&gt;orderBy('p.price', 'ASC');
$select-&gt;orderBy('p.price', Sql::ASC);

// ORDER BY &quot;price&quot; ASC, &quot;vat_rate&quot; DESC
$select-&gt;orderBy([
    'price' =&gt; Sql::ASC, // or just 'price' =&gt; 'ASC'
    'vat_rate' =&gt; Sql::DESC, // or just 'vat_rate' =&gt; 'DESC'
]);

$stmt = $select-&gt;execute(); // or $select-&gt;query(), returns a \PDOStatement instance or FALSE

// SELECT
//    &quot;category_id&quot; AS &quot;catId&quot;,
//    COUNT(*) AS &quot;numProducts&quot;
// FROM &quot;product&quot; WHERE &quot;price&quot; &gt; :gt1
// GROUP BY &quot;category_id&quot;
// HAVING &quot;numProducts&quot; &gt;= :gte1
$select = $db-&gt;select()
    -&gt;column('category_id', 'catId')
    -&gt;count('*', 'numProducts')
    -&gt;from('product');
    -&gt;where-&gt;gte('price', 10.0);
// using $select-&gt;where or $select-&gt;having changes the scope and the fluent interface
// method chain is broken

// add a GROUP BY
// GROUP BY &quot;category_id&quot; HAVING &quot;numProducts&quot; &lt; :lte1
$select-&gt;groupBy('category_id')
    -&gt;having-&gt;lte('numProducts', 5);

// SELECT MIN(&quot;price&quot;) FROM &quot;product&quot; GROUP BY &quot;category_id&quot;
$select = $db-&gt;select()-&gt;min('price')-&gt;from('product')-&gt;groupBy('category_id');
</code></pre>

<h3 id="dbinsert">Db::insert()</h3>
<p>Create and optionally execute an <code>P3\Db\Command\Insert</code> writer command instance.</p>
<pre><code class="php">// INSERT INTO &quot;product&quot; (&quot;name&quot;, &quot;price&quot;) VALUES (:val1, :val2)
$insert = $db-&gt;insert()
    -&gt;into('product')
    -&gt;row([
        'name' =&gt; 'product-1',
        'price' =&gt; 100.00,
    ]);

// equivalent to
$insert = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;values(['product-1', 100.00]);

$result = $insert-&gt;execute() // or $insert-&gt;exec(), returns TRUE or FALSE for single row insert
</code></pre>

<p><strong>Insert and execute</strong> shortcut call, when both arguments (<code>$table</code> and <code>$row</code>/<code>$rows</code>)
are provided:</p>
<pre><code class="php">$result = $db-&gt;insert('product', [
    'name' =&gt; 'product-111',
    'price' =&gt; 111.11,
]); // returns TRUE or FALSE for single insert

// get the last generated value if the insert is successful
$id = $result ? $db-&gt;lastInsertId() : null;
</code></pre>

<p>Insert many rows:</p>
<pre><code class="php">// INSERT INTO &quot;product&quot; (&quot;name&quot;, &quot;price&quot;) VALUES (:val1, :val2), (:val3, :val4)
$num_inserted = $db-&gt;insert('product', [
    [
        'name' =&gt; 'product-111',
        'price' =&gt; 111.11,
    ],
    [
        'name' =&gt; 'product-222',
        'price' =&gt; 222.22,
    ],
]); // returns integer or FALSE for multi-rows inserts

// equivalent to
$num_inserted = $db-&gt;insert()
    -&gt;into('product')
    -&gt;rows([
        [
            'name' =&gt; 'product-111',
            'price' =&gt; 111.11,
        ],
        [
            'name' =&gt; 'product-222',
            'price' =&gt; 222.22,
        ],
    ])-&gt;execute(); // or exec()

// and to
$num_inserted = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;values([
        'product-111',
        111.11,
    ])
    -&gt;values([
        'product-222',
        222.22,
    ])-&gt;execute(); // or exec()

// and to
$num_inserted = $db-&gt;insert()
    -&gt;into('product')
    -&gt;columns(['name', 'price'])
    -&gt;multipleValues([
        [
            'product-111',
            111.11,
        ],
        [
            'product-222',
            222.22,
        ],
    ])-&gt;execute();
</code></pre>

<p>By default <code>Insert::values(array $values, bool $reset = false)</code> and
<code>Insert::row(array $row, bool $reset = false)</code> will add new inset values to
existing ones. This can be changed by setting the 2nd
argument to <code>true</code>:</p>
<pre><code class="php">$insert = $db-&gt;insert('product');

$insert-&gt;row(['price' =&gt; 111.11, 'stock' =&gt; 111]); // adds 1 set of values
$insert-&gt;row(['price' =&gt; 222.22, 'stock' =&gt; 222]); // adds 1 set of values
// columns &quot;price&quot; and &quot;stock&quot; are alredy specified by previuous row() calls
$insert-&gt;values([333.33, 333]); // adds 1 set of values

$insert-&gt;execute(); // this will try to insert 3 rows

$insert-&gt;values([444.44, 444]); // adds another set of values
$insert-&gt;execute(); // this will try to insert 4 rows

 // adds 1 set of values after removing the old ones
$insert-&gt;row(['price' =&gt; 555.55, 'stock' =&gt; 555], true);
$insert-&gt;execute(); // this will try to insert 1 row
</code></pre>

<p>The opposite happens for <code>Insert::rows(array $rows, bool $reset = true)</code> and
<code>Insert::multipleValues(array $values, bool $reset = true)</code>. These methods calls
will insert the exact rows/values provided unless the 2nd argument is set to <code>false</code>.</p>
<h3 id="dbupdate">Db::update()</h3>
<p>The <code>P3\Db\Command\Update</code> command abstracts an INSERT operation</p>
<p>A non empty condition/predicate is required, otherwise an exception is thrown.</p>
<p>Examples:</p>
<pre><code class="php">// UPDATE &quot;product&quot; SET &quot;published&quot; = :set1 WHERE stock &gt; 0
$update = $db-&gt;update()-&gt;table('product')-&gt;set('published', true)-&gt;where('stock &gt; 0');
$update = $db-&gt;update('product')-&gt;set('published', true)-&gt;where('stock &gt; 0');
$affected = $update-&gt;execute(); // or exec()

// immediate command execution
// UPDATE &quot;product&quot; SET &quot;published&quot; = :set1 WHERE TRUE, we use the condition &quot;TRUE&quot; to update all records
$affected = $db-&gt;update('product', ['published' =&gt; true], 'TRUE');
</code></pre>

<h3 id="dbdelete">Db::delete()</h3>
<p>The <code>P3\Db\Command\Delete</code> command abstracts a SQL DELETE operation</p>
<p>A non empty condition/predicate is required, otherwise an exception is thrown.</p>
<p>Examples:</p>
<pre><code class="php">// DELETE FROM &quot;product&quot; WHERE stock &lt;= 0
$delete = $db-&gt;delete()-&gt;from('product')-&gt;where('stock &lt;= 0');
$delete = $db-&gt;delete('product')-&gt;where('stock &lt;= 0');
$num_deleted = $delete-&gt;execute(); // or exec()

// immediate command execution
// DELETE FROM &quot;product&quot; WHERE stock &lt;= 0
$num_deleted = $db-&gt;delete('product', 'stock &lt;= 0');
</code></pre>

<h3 id="sql-driver-proxy-helper-methods">Sql driver proxy helper methods</h3>
<ul>
<li><code>Db::quoteIdentifier(string $identifier)</code> quotes given column/table SQL identifier</li>
<li><code>Db::quoteAlias(string $alias)</code> quotes given SQL aliase</li>
<li><code>Db::quoteValue(null|scalar $value)</code> perform type-casting and quotes - when required - the given value</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/pine3ree/p3-db/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href=".." style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
